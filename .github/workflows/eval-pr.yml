name: eval-pr

on:
  pull_request:
  workflow_dispatch:

jobs:
  eval-smoke:
    runs-on: ubuntu-latest
    env:
      EVAL_RUN_ID: ${{ github.run_id }}-${{ github.run_attempt }}
      EVAL_API_KEY: ${{ secrets.EVAL_API_KEY }}
      EVAL_AUTH_HEADER: ${{ secrets.EVAL_AUTH_HEADER }}
      TRIAGE_URL: ${{ secrets.TRIAGE_URL }}
      EXPLAIN_URL: ${{ secrets.EXPLAIN_URL }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install runner deps
        run: pip install requests

      - name: Run smoke eval
        run: |
          python eval/runner/run_eval.py \
            --set smoke \
            --triage-url "$TRIAGE_URL" \
            --explain-url "$EXPLAIN_URL" \
            --budget-bypass \
            --run-id "$EVAL_RUN_ID" \
            --budget-bypass

      - name: Compare to baseline
        run: |
          python eval/runner/compare_to_baseline.py \
            --summary "eval/results/$EVAL_RUN_ID/summary.json" \
            --baseline "eval/baseline/summary.json" \
            --out "eval/results/$EVAL_RUN_ID/compare.json"

      - name: Publish job summary
        if: always()
        run: |
          echo "## Eval Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          cat "eval/results/$EVAL_RUN_ID/summary.md" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Baseline Comparison" >> "$GITHUB_STEP_SUMMARY"
          cat "eval/results/$EVAL_RUN_ID/compare.json" >> "$GITHUB_STEP_SUMMARY"
